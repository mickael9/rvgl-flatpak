app-id: org.rvgl.rvmm
runtime: org.freedesktop.Platform
runtime-version: '23.08'
sdk: org.freedesktop.Sdk
command: rvgl_launcher
finish-args:
  # X11 + XShm access
  - --share=ipc
  - --socket=x11
  # PulseAudio
  - --socket=pulseaudio
  # Discord Rich Presence
  - --filesystem=xdg-run/discord-ipc-0:rw
  # Read only access to host files
  # (mainly because wxPython does not support file drag-and-drop using XDG Desktop Portals)
  - --filesystem=host:ro
  - --filesystem=home:ro
  # OpenGL rendering / controller support
  - --device=all
  # Needs to talk to the network:
  - --share=network
  # Single-instance detection (see rvgl_launcher script)
  - --allow=per-app-dev-shm

cleanup:
  - /lib/cmake
  - /lib/pkgconfig
  - /lib/wx
  - /share/aclocal
  - /share/bakefile
  - '*.la'
  - '*.a'

modules:
  - name: wxWidgets
    cleanup:
      - /bin
      - /include
      - /share
      - /man
    config-opts:
      - --without-opengl
      - --without-subdirs
    sources:
      - type: archive
        url: https://github.com/wxWidgets/wxWidgets/releases/download/v3.2.3/wxWidgets-3.2.3.tar.bz2
        sha256: c170ab67c7e167387162276aea84e055ee58424486404bba692c401730d1a67a
        x-checker-data:
          type: html
          url: https://wxwidgets.org/downloads
          version-pattern: 'Latest Stable Release: ([\d\.]+)'
          url-template: https://github.com/wxWidgets/wxWidgets/releases/download/v$version/wxWidgets-$version.tar.bz2
      - type: script
        commands:
          - cp -p /usr/share/automake-*/config.{sub,guess} .
          - autoconf -f -B build/autoconf_prepend-include

  - python3-wxPython.yml

  - name: p7zip
    cleanup:
      - /include
      - /share
      - /man
    buildsystem: simple
    build-commands:
      - make -j $FLATPAK_BUILDER_N_JOBS 7z
      - make install DEST_HOME="${FLATPAK_DEST}"

    sources:
      - type: git
        url: https://github.com/p7zip-project/p7zip.git
        tag: v17.05
        commit: a45b8830cafda25e76d7120b0462daa82c382a7a
        x-checker-data:
          type: git
          tag-pattern: "^v([\\d.]+)$"

  - python3-modules.json

  - name: rvgl_launcher
    buildsystem: simple
    build-commands:
      - mkdir -p "${FLATPAK_DEST}/share/rvgl-launcher/"
      - cp -r rvgl_launcher.py repos icons rv_launcher -t "${FLATPAK_DEST}/share/rvgl-launcher"
      - mkdir "${FLATPAK_DEST}/share/rvgl-launcher/.git" # avoid auto updates (which wouldn't work anyway)
      - install -D ${FLATPAK_ID}.desktop -t "${FLATPAK_DEST}/share/applications/"
      - install -D ${FLATPAK_ID}.metainfo.xml "${FLATPAK_DEST}/share/metainfo/${FLATPAK_ID}.metainfo.xml"
      - install -D icons/icon.png  "${FLATPAK_DEST}/share/icons/hicolor/256x256/apps/${FLATPAK_ID}.png"
      - install -D rvgl_launcher -t "${FLATPAK_DEST}/bin/"
    sources:
      - type: file
        path: org.rvgl.rvmm.desktop

      - type: file
        path: org.rvgl.rvmm.metainfo.xml

      - type: git
        url: https://gitlab.com/re-volt/rvgl-launcher.git
        tag: 0.1.23.510a1
        commit: 80c033b239641c655b2963f9605b59468ef992e3
        x-checker-data:
          type: git
          tag-pattern: '^(\d+(?:\.\d+)+(?:a\d+)?)$'

      - type: file
        path: rvgl_launcher
